
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin
    function isAdmin(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.role == 'admin';
    }

    // Helper function to check if a user is a lojista
    function isLojista(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.role == 'lojista';
    }

    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if a user is the owner of a document
    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    // Users collection rules
    match /users/{userId} {
      // Users can read their own data. Admins can read any user data.
      allow read: if isOwner(userId) || isAdmin(request.auth.uid);
      
      // New users can create their own profile.
      allow create: if isOwner(userId);

      // Users can update their own data, but cannot change their role or verification status.
      // Admins can update any user data.
      allow update: if (isOwner(userId) && 
                       request.resource.data.role == resource.data.role &&
                       request.resource.data.verificationStatus == resource.data.verificationStatus) ||
                      isAdmin(request.auth.uid);
                      
      // Only admins can delete users.
      allow delete: if isAdmin(request.auth.uid);
    }

    // Products collection rules
    match /products/{productId} {
      // Anyone can read products
      allow read: if true;
      // Only admins and lojistas can create, update, or delete products
      allow write: if isAuthenticated() && (isAdmin(request.auth.uid) || isLojista(request.auth.uid));
    }

    // Group promotions rules
    match /groupPromotions/{groupId} {
      // Any authenticated user can create a group or read the list of groups.
      allow create, list: if isAuthenticated();
      
      // Only members of the group or admins can read group details.
      allow get: if isAuthenticated() && 
                   (exists(/databases/$(database)/documents/groupPromotions/$(groupId)/members/$(request.auth.uid)) ||
                    isAdmin(request.auth.uid));
                    
      // Only the creator or an admin can update or delete a group.
      allow update, delete: if isAuthenticated() && 
                             (resource.data.creatorId == request.auth.uid ||
                              isAdmin(request.auth.uid));

      // Subcollection rules for group promotions
      match /members/{userId} {
        // The group creator and admins can add/remove members.
        allow write: if isAuthenticated() && 
                       (get(/databases/$(database)/documents/groupPromotions/$(groupId)).data.creatorId == request.auth.uid ||
                        isAdmin(request.auth.uid));
        // Members of the group and admins can read the member list.
        allow read: if isAuthenticated() && 
                      (exists(/databases/$(database)/documents/groupPromotions/$(groupId)/members/$(request.auth.uid)) ||
                       isAdmin(request.auth.uid));
      }
      
      match /joinRequests/{userId} {
          // A user can request to join.
          allow create: if isOwner(userId);
          // The group creator and admins can read and delete requests.
          allow read, delete: if isAuthenticated() && 
                               (get(/databases/$(database)/documents/groupPromotions/$(groupId)).data.creatorId == request.auth.uid ||
                                isAdmin(request.auth.uid));
      }
      
      match /messages/{messageId} {
        // Only members of the group can read/write messages.
        allow read, write: if isAuthenticated() && 
                             exists(/databases/$(database)/documents/groupPromotions/$(groupId)/members/$(request.auth.uid));
      }
      
      match /groupCart/{itemId} {
         // Only members of the group can read/write to the cart.
         allow read, write: if isAuthenticated() && 
                              exists(/databases/$(database)/documents/groupPromotions/$(groupId)/members/$(request.auth.uid));
      }
      
      match /contributions/{userId} {
         // Only members of the group can create their own contribution.
         allow create: if isOwner(userId) &&
                        exists(/databases/$(database)/documents/groupPromotions/$(groupId)/members/$(request.auth.uid));
         // Only members and admins can read contributions.
         allow read: if isAuthenticated() && 
                       (exists(/databases/$(database)/documents/groupPromotions/$(groupId)/members/$(request.auth.uid)) ||
                        isAdmin(request.auth.uid));
      }
    }
    
    // Orders collection rules
    match /orders/{orderId} {
        // Only admins can read or write orders. In a real scenario, you might allow
        // the user who is part of the order to read it.
        allow read, write: if isAuthenticated() && isAdmin(request.auth.uid);
        
        match /contributions/{contributionId} {
           allow read, write: if isAuthenticated() && isAdmin(request.auth.uid);
        }
    }

    // Service Requests collection rules
    match /serviceRequests/{requestId} {
        // A client can create their own request.
        allow create: if isAuthenticated() && request.resource.data.clientId == request.auth.uid;
        
        // The client who made the request, the lojista assigned to it, or an admin can read it.
        allow read: if isAuthenticated() && 
                      (request.resource.data.clientId == request.auth.uid ||
                       request.resource.data.lojistaId == request.auth.uid ||
                       isAdmin(request.auth.uid));
                       
        // The lojista or an admin can update the status. The client can cancel it.
        allow update: if isAuthenticated() &&
                        ((isLojista(request.auth.uid) && resource.data.lojistaId == request.auth.uid) ||
                         isAdmin(request.auth.uid) ||
                         (isOwner(request.resource.data.clientId) && request.resource.data.status == 'cancelado'));
                         
        // Only admins can delete requests for record-keeping purposes.
        allow delete: if isAdmin(request.auth.uid);
    }
  }
}
